var canvas,rect,bufferLargePixel,canvasWidth=400,canvasHeight=400,useInterval=!0,flipImaginaryAxis=1,pixelSizes=[8,5,1],largePixelSize=15,mandelbrotCalls=new Array(pixelSizes.length),drawColumnIDs=new Array(pixelSizes.length),bufferArray=new Array(pixelSizes.length),isLoaded=!1,thread=null,canvasWrapper=document.getElementById("canvasWrapper");let app=new PIXI.Application({width:canvasWrapper.clientWidth,height:canvasWrapper.clientWidth});canvasWidth=canvasWrapper.clientWidth,canvasHeight=canvasWidth,bufferLargePixel=new PIXI.Graphics,app.stage.addChild(bufferLargePixel);for(var j=0;j<pixelSizes.length;j++)bufferArray[j]=new PIXI.Graphics,app.stage.addChild(bufferArray[j]);canvasWrapper.appendChild(app.view);var oldX,oldY,newX,newY,pinchInitial,isDragging=!(app.stage.interactive=!0),adjX=0,adjY=0,tempZooms=zooms,tempPanX=panX,tempPanY=panY;function getDistance(e){var a=e[0].clientX-e[1].clientX,e=e[0].clientY-e[1].clientY;return Math.sqrt(a*a+e*e)}function drawOnTouch(){document.getElementById("xa").value=panX,document.getElementById("ya").value=panY,document.getElementById("za").value=zooms,pallete.setNumberRange(0,maxI),show(),abortRun(),startRun()}function abortRun(){for(var e=0;e<mandelbrotCalls.length;e++)clearTimeout(mandelbrotCalls[e]);if(useInterval)for(e=0;e<drawColumnIDs.length;e++)clearInterval(drawColumnIDs[e]);else for(e=0;e<drawColumnIDs.length;e++)cancelAnimationFrame(drawColumnIDs[e]);for(var a=0;a<pixelSizes.length;a++)bufferArray[a].clear()}function startRun(){mandelbrotLargePixel(zooms,panX,panY);for(var e=0;e<pixelSizes.length;e++)mandelbrotCalls[e]=setTimeout(function(e){return function(){mandelbrot(zooms,panX,panY,pixelSizes[e],e)}}(e))}app.view.onmousedown=function(e){e.preventDefault(),isLoaded&&(rect=app.view.getBoundingClientRect(),isDragging=!0,oldX=e.clientX-rect.left,oldY=e.clientY-rect.top,tempZooms=zooms,tempPanX=panX,tempPanY=panY,abortRun())},app.view.onmousemove=function(e){e.preventDefault(),isLoaded&&isDragging&&(rect=app.view.getBoundingClientRect(),newX=e.clientX-rect.left,newY=e.clientY-rect.top,mandelbrotLargePixel(tempZooms,tempPanX-(adjX=panX+newX/zooms-(panX+oldX/zooms)),tempPanY-(adjY=panY+flipImaginaryAxis*(newY/zooms)-(panY+flipImaginaryAxis*(oldY/zooms)))))},app.view.onmouseup=function(e){e.preventDefault(),isLoaded&&(isDragging=!1,panX=tempPanX,panY=tempPanY,panY-=adjY,pan=(panX-=adjX)+2/(zooms=tempZooms)-(panX-1/zooms),adjY=adjX=0,drawOnTouch(e))},app.view.onmouseleave=function(e){e.preventDefault(),isLoaded&&isDragging&&(isDragging=!1,panX=tempPanX,panY=tempPanY,panY-=adjY,pan=(panX-=adjX)+2/(zooms=tempZooms)-(panX-1/zooms),adjY=adjX=0,drawOnTouch(e))},app.view.onwheel=function(e){var a,n,t;abortRun(),e.preventDefault(),isLoaded&&(a=e.deltaY,n=panX+canvasWidth/2/zooms,t=panY+flipImaginaryAxis*(canvasHeight/2/zooms),0<a?zooms/=zf:a<0&&(zooms*=zf),mandelbrotLargePixel(zooms,panX=n-canvasWidth/2/zooms,panY=t-flipImaginaryAxis*(canvasHeight/2/zooms)),drawOnTouch(e))},app.view.ontouchstart=function(e){var a;e.preventDefault(),isLoaded&&(rect=app.view.getBoundingClientRect(),1===e.touches.length?(isDragging=!0,a=e.touches[0],oldX=a.clientX-rect.left,oldY=a.clientY-rect.top):2===e.touches.length&&(pinchInitial=getDistance(e.touches)),tempZooms=zooms,tempPanX=panX,tempPanY=panY,abortRun())},app.view.ontouchmove=function(e){if(e.preventDefault(),isLoaded){if(rect=app.view.getBoundingClientRect(),2===e.touches.length){var a=getDistance(e.touches),n=tempPanY+flipImaginaryAxis*(canvasHeight/2/tempZooms);tempPanX=tempPanX+canvasWidth/2/tempZooms-canvasWidth/2/(tempZooms*=a/pinchInitial),tempPanY=n-flipImaginaryAxis*(canvasHeight/2/tempZooms)}else if(1===e.touches.length){if(!isDragging)return;a=e.touches[0],n=(newX=a.clientX-rect.left,newY=a.clientY-rect.top,panX+oldX/zooms);adjX=panX+newX/zooms-n,adjY=panY+flipImaginaryAxis*(newY/zooms)-(panY+flipImaginaryAxis*(oldY/zooms))}mandelbrotLargePixel(tempZooms,tempPanX-adjX,tempPanY-adjY)}},app.view.ontouchend=function(e){e.preventDefault(),isLoaded&&(isDragging=!1,panX=tempPanX,panY=tempPanY,panY-=adjY,pan=(panX-=adjX)+2/(zooms=tempZooms)-(panX-1/zooms),adjY=adjX=0,drawOnTouch(e))};var pan,zooms,panX,panY,zf,coloringType,maxI=50,pallete=new Rainbow,_pallete=(pallete.setSpectrum("#000764","#206bcb","#edffff","#ffaa00","#000200"),pallete.setNumberRange(0,maxI),["#000764","#206bcb","#edffff","#ffaa00","#000200"]);function mdbl(e,a,n,t,o,l,i){for(var r=0;r<canvasHeight;r+=o){for(var s,p=n+e/a,m=t+flipImaginaryAxis*(r/a),d=0,c=0,u=0;d*d+c*c<=4&&u<maxI;)s=d*d-c*c+p,c=2*d*c+m,d=s,u+=1;l(e,r,d,c,u,o,i)}}function mandelbrot(a,n,t,o,l){var i;i=0,drawColumnIDs[l]=useInterval?setInterval(function(){i<canvasWidth?(mdbl(i,a,n,t,o,coloringMethod,l),i+=o):clearInterval(drawColumnIDs[l])}):requestAnimationFrame(function e(){i<canvasWidth?(mdbl(i,a,n,t,o,coloringMethod,l),i+=o,drawColumnIDs[l]=requestAnimationFrame(e)):cancelAnimationFrame(drawColumnIDs[l])})}function mandelbrotLargePixel(e,a,n){var t;for(bufferLargePixel.clear(),t=0;t<canvasWidth;)mdbl(t,e,a,n,largePixelSize,coloringMethod,null),t+=largePixelSize}function coloringMethod(e,a,n,t,o,l,i){var r=null,r=null===i?bufferLargePixel:bufferArray[i];"smoothColoring"===coloringType?o<maxI?(i=Math.log(n*n+t*t)/2,n=Math.log(i/Math.log(2))/Math.log(2),r.beginFill(color((o=o+1-n)/maxI*(_pallete.length-1)))):r.beginFill("#000000"):r.beginFill(color(o)),r.drawRect(e,a,l,l),r.endFill()}function color(e){switch(coloringType){case"escapeTime":return"#"+pallete.colourAt(e);case"smoothColoring":return interpolation(e);default:return"#"+pallete.colourAt(e)}}function hexToRGBObject(e){return e=(e+"").replace("#",""),{r:parseInt(e.charAt(0)+e.charAt(1),16),g:parseInt(e.charAt(2)+e.charAt(3),16),b:parseInt(e.charAt(4)+e.charAt(5),16)}}function linear_interpolate(e,a,n){return"rgb("+Math.floor((a.r-e.r)*n+e.r)+","+Math.floor((a.g-e.g)*n+e.g)+","+Math.floor((a.b-e.b)*n+e.b)+")"}function interpolation(e){return linear_interpolate(hexToRGBObject(_pallete[Math.floor(e)]),hexToRGBObject(_pallete[Math.floor(e)+1]),e%1)}function work(){isLoaded&&(pan=.1,zooms=canvasWidth/4,panX=-2.5,panY=-2*(flipImaginaryAxis=1),zf=1.1,maxI=50,pallete.setSpectrum("#000764","#206bcb","#edffff","#ffaa00","#000200"),pallete.setNumberRange(0,maxI),_pallete=["#000764","#206bcb","#edffff","#ffaa00","#000200"],coloringType="smoothColoring",document.getElementById(coloringType).checked=!0,document.getElementById("flipImaginaryAxis").checked=!0,document.getElementById("xa").value=panX,document.getElementById("ya").value=panY,document.getElementById("za").value=zooms,show(),abortRun(),startRun())}function resetCoordinates(){isLoaded&&(pan=.1,zooms=canvasWidth/4,panX=-2.5,panY=-2*flipImaginaryAxis,document.getElementById("xa").value=panX,document.getElementById("ya").value=panY,document.getElementById("za").value=zooms,show(),abortRun(),startRun())}function flipImagAxis(){isLoaded&&(flipImaginaryAxis=1==flipImaginaryAxis?-1:1,panY*=-1,document.getElementById("ya").value=panY,show(),abortRun(),startRun())}function xScroll(e){isLoaded&&(e=e?parseFloat(document.getElementById("xa").value)+pan:parseFloat(document.getElementById("xa").value)-pan,document.getElementById("xa").value=e,panX=e,show(),abortRun(),startRun())}function yScroll(e){isLoaded&&(e=e?parseFloat(document.getElementById("ya").value)+pan:parseFloat(document.getElementById("ya").value)-pan,document.getElementById("ya").value=e,panY=e,show(),abortRun(),startRun())}function drawAgain(){isLoaded&&(panX=parseFloat(document.getElementById("xa").value),panY=parseFloat(document.getElementById("ya").value),zooms=parseFloat(document.getElementById("za").value),show(),abortRun(),startRun())}function zoomIn(){isLoaded&&(pan=panX+2/(zooms+=zf)-(panX-1/zooms),document.getElementById("za").value=zooms,show(),abortRun(),startRun())}function zoomOut(){isLoaded&&(pan=panX+2/(zooms-=zf)-(panX-1/zooms),document.getElementById("za").value=zooms,show(),abortRun(),startRun())}function zoomFactor(){var e;isLoaded&&(e=document.getElementById("zf").value,zf=parseFloat(e),show())}function changeMaxI(){var e;isLoaded&&(e=document.getElementById("mi").value,maxI=parseInt(e),pallete.setNumberRange(0,maxI),show(),abortRun(),startRun())}function changeColoringType(e){isLoaded&&(e=e.value,coloringType=e,show(),abortRun(),startRun())}function changePallete(){var e;isLoaded&&((e=document.getElementById("plt").value.split(" ")).length<3?alert(" Please enter more colors "):(pallete.setSpectrumByArray(e),show(),abortRun(),startRun()))}function changeCoords(){var e;isLoaded&&((e=document.getElementById("crd").value.split(" ")).length<4?alert(" Please enter complete details"):(panX=parseFloat(e[0]),panY=parseFloat(e[1]),zooms=parseFloat(e[2]),maxI=parseFloat(e[3]),zf=1.5,pan=panX+2/zooms-(panX-1/zooms),pallete.setNumberRange(0,maxI),document.getElementById("xa").value=panX,document.getElementById("ya").value=panY,document.getElementById("za").value=zooms,document.getElementById("mi").value=maxI,document.getElementById("zf").value=zf,show(),abortRun(),startRun()))}function fullResize(){}function resize(){canvasWidth=canvas.width=parseInt(prompt("Please enter canvas width in pixels",200))||200,canvasHeight=canvas.height=parseInt(prompt("Please enter canvas height in pixels",200))||200,work()}function iterationsTimesTwo(){isLoaded&&(maxI*=2,show(),abortRun(),startRun())}function iterationsDividedByTwo(){isLoaded&&(maxI/=2,show(),abortRun(),startRun())}function changeBigPixelSize(){isLoaded&&Swal.fire({title:"Info",input:"text",text:"Change big pixel size",inputValue:20,inputPlaceholder:"20"}).then(function(e){e=parseInt(e.value);Number.isNaN(e)?Swal.fire({icon:"error",title:"Error",text:"Invalid number!"}):largePixelSize=e})}function show(){var e="Scroll: "+pan+"<br /> Current zoom: "+zooms+"<br /> left: "+panX+"<br /> right: "+(panX+canvasWidth/zooms)+"<br /> top: "+panY+"<br /> bottom: "+(panY+flipImaginaryAxis*(canvasHeight/zooms))+"<br /> zoom factor: "+zf+"<br /> max iterations of loop: "+maxI+"<br /> uses "+coloringType+" algorithm for coloring";document.getElementById("dtls").innerHTML=e}function about(){Swal.fire({icon:"info",title:"About",text:"A mandelbrot set generator in javascript created by pvzzombs. "})}function startMandelbrot(){(thread=new Worker("getOptimalPixel.js")).onmessage=function(e){console.log("Time is ",e.data.ms),console.log("Pixel is ",e.data.pixelSize),isLoaded=!0,largePixelSize=e.data.pixelSize,work(),document.getElementById("loadingText").innerText=""}}startMandelbrot();