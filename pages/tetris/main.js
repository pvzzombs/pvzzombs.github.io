let side=15,GRIDCELLWCOUNT=10,GRIDCELLHCOUNT=20,GRIDCELLW=GRIDCELLWCOUNT*side,GRIDCELLH=GRIDCELLHCOUNT*side,W=300,H=400;var tetromino={I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],L:[[1,0,0],[1,1,1],[0,0,0]],J:[[0,0,1],[1,1,1],[0,0,0]],O:[[1,1],[1,1]],S:[[0,1,1],[1,1,0],[0,0,0]],T:[[0,1,0],[1,1,1],[0,0,0]],Z:[[1,1,0],[0,1,1],[0,0,0]]},tetrominoStart={I:{x:3,y:-1},L:{x:4,y:0},J:{x:3,y:0},O:{x:4,y:0},S:{x:4,y:0},T:{x:4,y:0},Z:{x:4,y:0}};function rotateBody(o){for(var t=o.length,r=o[0].length,e=0;e<t;e++)for(var n=0;n<e+1;n++){var i=o[e][n];o[e][n]=o[n][e],o[n][e]=i}for(e=0;e<t;e++)for(var m=0,a=r-1;m<=Math.floor((r-1)/2);){i=o[e][m];o[e][m]=o[e][a],o[e][a]=i,m++,a--}return o}function copyTetromino(o){for(var t=[],r=0;r<o.length;r++)t[r]=o[r].slice();return t}var currentTetromino=null,toX=-1,toY=-1,ghostX=-1,ghostY=-1,grid=[];function tryMove(o){if("down"===o){for(var t=toY+1,r=0;r<currentTetromino.length;r++)for(var e=0;e<currentTetromino[0].length;e++)if(!(t+r<0)){if(1===currentTetromino[r][e]&&t+r>=GRIDCELLHCOUNT)return"ground";if(1===currentTetromino[r][e]&&0!==grid[t+r][toX+e])return"tetromino"}}else if("left"===o){for(var n=toX-1,r=0;r<currentTetromino.length;r++)for(e=0;e<currentTetromino[0].length;e++)if(!(toY+r<0)){if(1===currentTetromino[r][e]&&n+e<0)return"wall";if(1===currentTetromino[r][e]&&0!==grid[toY+r][n+e])return"tetromino"}}else if("right"===o)for(n=toX+1,r=0;r<currentTetromino.length;r++)for(e=0;e<currentTetromino[0].length;e++)if(!(toY+r<0)){if(1===currentTetromino[r][e]&&n+e>=GRIDCELLWCOUNT)return"wall";if(1===currentTetromino[r][e]&&0!==grid[toY+r][n+e])return"tetromino"}return""}function tryMoveGhost(o){if("down"===o)for(var t=ghostY+1,r=0;r<currentTetromino.length;r++)for(var e=0;e<currentTetromino[0].length;e++){if(1===currentTetromino[r][e]&&t+r>=GRIDCELLHCOUNT)return"ground";if(1===currentTetromino[r][e]&&0!==grid[t+r][ghostX+e])return"tetromino"}return""}function tryRotate(){for(var o=rotateBody(copyTetromino(currentTetromino)),t=0;t<o.length;t++)for(var r=0;r<o[0].length;r++)if(!(toY+t<0)){if(1===o[t][r]&&toY+t>=GRIDCELLHCOUNT)return"ground";if(1===o[t][r]&&toX+r>=GRIDCELLWCOUNT)return"wall";if(1===o[t][r]&&toX+r<0)return"wall";if(1===o[t][r]&&0!==grid[toY+t][toX+r])return"tetromino"}return""}function copyTetrominoToGrid(){for(var o=0;o<currentTetromino.length;o++)for(var t=0;t<currentTetromino[0].length;t++)o+toY<0||t+toX<0||toY+o>=GRIDCELLHCOUNT||toX+t>=GRIDCELLWCOUNT||1===currentTetromino[o][t]&&(grid[toY+o][toX+t]=1)}var tetrominoes=["I","L","J","O","S","T","Z"],currentID=0;function shuffle(){if(++currentID>=tetrominoes.length)for(var o=currentID=0;o<tetrominoes.length;o++){var t=Math.floor(Math.random()*(tetrominoes.length-1-o)+o),r=tetrominoes[o];tetrominoes[o]=tetrominoes[t],tetrominoes[t]=r}}function spawnTetromino(){currentTetromino=copyTetromino(tetromino[tetrominoes[currentID]]),toX=tetrominoStart[tetrominoes[currentID]].x,toY=tetrominoStart[tetrominoes[currentID]].y;for(var o=0;o<currentTetromino.length;o++)for(var t=0;t<currentTetromino[0].length;t++)if(!(toY+o<0)&&1===currentTetromino[o][t]&&0!==grid[toY+o][toX+t])return noLoop(),void console.log("Game Over!")}function spawnGhostTetromino(){for(ghostX=toX,ghostY=toY;""===tryMoveGhost("down");)ghostY++}function checkRows(){for(var o=GRIDCELLHCOUNT-1,t=GRIDCELLHCOUNT-1;0<=t;t--){for(var r=!0,e=0;e<GRIDCELLWCOUNT;e++)if(0===grid[t][e]){r=!1;break}if(!r){for(e=0;e<GRIDCELLWCOUNT;e++){var n=grid[t][e];grid[t][e]=grid[o][e],grid[o][e]=n}o--}}for(t=0;t<GRIDCELLHCOUNT;t++){for(var i=!0,e=0;e<GRIDCELLWCOUNT;e++)0===grid[t][e]&&(i=!1);if(i)for(e=0;e<GRIDCELLWCOUNT;e++)grid[t][e]=0}}function moveDown(){""===tryMove("down")?toY+=1:(copyTetrominoToGrid(),checkRows(),spawnTetromino(),shuffle()),spawnGhostTetromino()}var imgLeftButton=null,imgRightButton=null,imgUpButton=null,imgDownButton=null;function preload(){imgLeftButton=loadImage("img/left.png"),imgRightButton=loadImage("img/right.png"),imgUpButton=loadImage("img/up.png"),imgDownButton=loadImage("img/down.png"),imgBoostButton=loadImage("img/arrowDown.png")}function setup(){createCanvas(W,H),frameRate(60);for(var o=0;o<GRIDCELLHCOUNT;o++){grid.push(new Array(GRIDCELLWCOUNT));for(var t=0;t<GRIDCELLWCOUNT;t++)grid[o][t]=0}for(o=0;o<tetrominoes.length;o++){var r=Math.floor(Math.random()*(tetrominoes.length-1-o)+o),e=tetrominoes[o];tetrominoes[o]=tetrominoes[r],tetrominoes[r]=e}spawnTetromino(),shuffle(),spawnGhostTetromino()}var frameCounter=0,elapsedDT=0;function draw(){background(128),strokeWeight(2);for(var o=0;o<GRIDCELLHCOUNT;o++)for(var t=0;t<GRIDCELLWCOUNT;t++)1===grid[o][t]?fill("green"):fill("white"),rect(t*side,o*side,side,side);for(o=0;o<currentTetromino.length;o++)for(t=0;t<currentTetromino[0].length;t++)1===currentTetromino[o][t]&&(fill("gray"),rect((ghostX+t)*side,(ghostY+o)*side,side,side));for(o=0;o<currentTetromino.length;o++)for(t=0;t<currentTetromino[0].length;t++)1===currentTetromino[o][t]&&(fill("blue"),rect((toX+t)*side,(toY+o)*side,side,side));1e3<=(elapsedDT+=deltaTime)&&(moveDown(),elapsedDT=0),image(imgLeftButton,0,340,50,50),image(imgRightButton,50,340,50,50),image(imgUpButton,100,340,50,50),image(imgDownButton,150,340,50,50),image(imgBoostButton,200,340,50,50)}function keyPressed(){if("s"===key||"S"===key)moveDown();else if("a"===key||"A"===key)""===tryMove("left")&&(--toX,elapsedDT=0,spawnGhostTetromino());else if("d"===key||"D"===key)""===tryMove("right")&&(toX+=1,elapsedDT=0,spawnGhostTetromino());else if("W"===key||"w"===key)""===tryRotate()&&(elapsedDT=0,rotateBody(currentTetromino),spawnGhostTetromino());else if(" "===key)for(elapsedDT=0;""===tryMove("down");)moveDown()}function touchStarted(){var o=touches[0],t=o.x,o=o.y;if(0<t&&t<50&&340<o&&o<390&&""===tryMove("left")&&(--toX,elapsedDT=0,spawnGhostTetromino()),50<t&&t<100&&340<o&&o<390&&""===tryMove("right")&&(toX+=1,elapsedDT=0,spawnGhostTetromino()),100<t&&t<150&&340<o&&o<390&&""===tryRotate()&&(elapsedDT=0,rotateBody(currentTetromino),spawnGhostTetromino()),150<t&&t<200&&340<o&&o<390&&moveDown(),200<t&&t<250&&340<o&&o<390)for(elapsedDT=0;""===tryMove("down");)moveDown()}