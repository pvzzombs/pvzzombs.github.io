let side=10,GRIDCELLWCOUNT=10,GRIDCELLHCOUNT=20,GRIDCELLW=GRIDCELLWCOUNT*side,GRIDCELLH=GRIDCELLHCOUNT*side;var tetromino={I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],L:[[1,0,0],[1,1,1],[0,0,0]],J:[[0,0,1],[1,1,1],[0,0,0]],O:[[1,1],[1,1]],S:[[0,1,1],[1,1,0],[0,0,0]],T:[[0,1,0],[1,1,1],[0,0,0]],Z:[[1,1,0],[0,1,1],[0,0,0]]},tetrominoStart={I:{x:3,y:-1},L:{x:4,y:0},J:{x:3,y:0},O:{x:4,y:0},S:{x:4,y:0},T:{x:4,y:0},Z:{x:4,y:0}};function rotateBody(r){for(var o=r.length,t=r[0].length,e=0;e<o;e++)for(var n=0;n<e+1;n++){var i=r[e][n];r[e][n]=r[n][e],r[n][e]=i}for(e=0;e<o;e++)for(var f=0,u=t-1;f<=Math.floor((t-1)/2);){i=r[e][f];r[e][f]=r[e][u],r[e][u]=i,f++,u--}return r}function copyTetromino(r){for(var o=[],t=0;t<r.length;t++)o[t]=r[t].slice();return o}var currentTetromino=tetromino.L,toX=tetrominoStart.L.x,toY=tetrominoStart.L.y,grid=[];function tryMove(r){if("down"===r)for(var o=toY+1,t=0;t<currentTetromino.length;t++)for(var e=0;e<currentTetromino[0].length;e++){if(1===currentTetromino[t][e]&&o+t>=GRIDCELLHCOUNT)return"ground";if(1===currentTetromino[t][e]&&0!==grid[o+t][toX+e])return"tetromino"}else if("left"===r)for(var n=toX-1,t=0;t<currentTetromino.length;t++)for(e=0;e<currentTetromino[0].length;e++){if(1===currentTetromino[t][e]&&n+e<0)return"wall";if(1===currentTetromino[t][e]&&0!==grid[toY+t][n+e])return"tetromino"}else if("right"===r)for(n=toX+1,t=0;t<currentTetromino.length;t++)for(e=0;e<currentTetromino[0].length;e++){if(1===currentTetromino[t][e]&&n+e>=GRIDCELLWCOUNT)return"wall";if(1===currentTetromino[t][e]&&0!==grid[toY+t][n+e])return"tetromino"}return""}function tryRotate(){for(var r=rotateBody(copyTetromino(currentTetromino)),o=0;o<r.length;o++)for(var t=0;t<r[0].length;t++)if(!(toY+o<0)){if(1===r[o][t]&&toY+o>=GRIDCELLHCOUNT)return"ground";if(1===r[o][t]&&toX+t>=GRIDCELLWCOUNT)return"wall";if(1===r[o][t]&&toX+t<0)return"wall";if(1===r[o][t]&&0!==grid[toY+o][toX+t])return"tetromino"}return""}function copyTetrominoToGrid(){for(var r=0;r<currentTetromino.length;r++)for(var o=0;o<currentTetromino[0].length;o++)r+toY<0||o+toX<0||toY+r>=GRIDCELLHCOUNT||toX+o>=GRIDCELLWCOUNT||1===currentTetromino[r][o]&&(grid[toY+r][toX+o]=1)}var tetrominoes=["I","L","J","O","S","T","Z"],currentID=0;function shuffle(){++currentID>=tetrominoes.length&&(currentID=0)}function spawnTetromino(){currentTetromino=copyTetromino(tetromino[tetrominoes[currentID]]),toX=tetrominoStart[tetrominoes[currentID]].x,toY=tetrominoStart[tetrominoes[currentID]].y;for(var r=0;r<currentTetromino.length;r++)for(var o=0;o<currentTetromino[0].length;o++)if(!(toY+r<0)&&1===currentTetromino[r][o]&&0!==grid[toY+r][toX+o])return noLoop(),void console.log("Game Over!")}function checkRows(){for(var r=GRIDCELLHCOUNT-1,o=GRIDCELLHCOUNT-1;0<=o;o--){for(var t=!0,e=0;e<GRIDCELLWCOUNT;e++)if(0===grid[o][e]){t=!1;break}if(!t){for(e=0;e<GRIDCELLWCOUNT;e++){var n=grid[o][e];grid[o][e]=grid[r][e],grid[r][e]=n}r--}}for(o=0;o<GRIDCELLHCOUNT;o++){for(var i=!0,e=0;e<GRIDCELLWCOUNT;e++)0===grid[o][e]&&(i=!1);if(i)for(e=0;e<GRIDCELLWCOUNT;e++)grid[o][e]=0}}function moveDown(){""===tryMove("down")?toY+=1:(copyTetrominoToGrid(),checkRows(),spawnTetromino(),shuffle())}function setup(){createCanvas(GRIDCELLW,GRIDCELLH),frameRate(60);for(var r=0;r<GRIDCELLHCOUNT;r++){grid.push(new Array(GRIDCELLWCOUNT));for(var o=0;o<GRIDCELLWCOUNT;o++)grid[r][o]=0}spawnTetromino(),shuffle()}var frameCounter=0;function draw(){background(128),strokeWeight(2);for(var r=0;r<GRIDCELLHCOUNT;r++)for(var o=0;o<GRIDCELLWCOUNT;o++)1===grid[r][o]?fill("green"):fill("white"),rect(o*side,r*side,side,side);fill("red");for(r=0;r<currentTetromino.length;r++)for(o=0;o<currentTetromino[0].length;o++)1===currentTetromino[r][o]&&(fill("blue"),rect((toX+o)*side,(toY+r)*side,side,side));20<=++frameCounter&&(moveDown(),frameCounter=0)}function keyPressed(){"s"===key||"S"===key?moveDown():"a"===key||"A"===key?""===tryMove("left")&&--toX:"d"===key||"D"===key?""===tryMove("right")&&(toX+=1):"W"!==key&&"w"!==key||""===tryRotate()&&rotateBody(currentTetromino)}